# mfe-dependency-analyzer

Generate a simple report to understand the imports across your microfrontend application. The report generated by this tool should be used in conjunction with **mfe-dependency-aggregator** (still not created) to be able to identify and visualize dependencies across all microfrontends.

## Installation

- `yarn add -D mfe-dependencies-analyzer`
- Add script to package.json

      // to run manually
      "mfedeps": "mfedeps"
      // OR execute after tests pass
      "posttest": "mfedeps"

### Usage

```sh
USAGE
  $ mfedeps

OPTIONS
  -d, --dir=dir      [default: .] Project source dir to analyze
  -f, --files=files  [default: "src/**/!(*.test|*.spec).js"] Glob pattern of files inside dir to analyze
  -h, --help         show CLI help
  -n, --name=name    Microfrontend application name
  -r, --visualize    Open local visualization report
  -v, --version      show CLI version
```

### Output

By default, the output JSON report will be printed to stdout.

```js
{
  "name": "@example/home", // application name
  "dependencies": [
    // array of dependencies objects
    {
      "type": "ES6", // ES6 import || require
      "import": [
        {
          "type": "default", // type of import, eg. import React from 'react'
          "name": "React" // what it is called from the source
        },
        {
          "type": "specifier", // type of import, eg. import { useEffect } from 'react'
          "name": "useState"
        }
      ],
      "module": "react", // name of module
      "source": "/dev/home/src/about.component.js", // file path
      "external": true // is external, meaning it is not bundled and therefore a shared-dependency
    }
  ]
}
```

## Development

- `git clone --recursive https://github.com/filoxo/mfe-dependency-analyzer.git`
- `yarn install`
- `yarn --cwd mfe-deps-test-repo install`
- Execute locally

```sh
./bin/run -d mfe-dependencies-test-repo -f "src/**/!(*.test|*.spec).js" -r
# the quoted --files glob above is necessary to prevent some shell file expansion
```

### Testing

- Run `yarn test`

The tests use a hybrid of real files ([mfe-dependencies-test-repo](https://github.com/filoxo/mfe-deps-test-repo)) and virtual file fixtures. Here's how it works:

- [memfs](https://github.com/streamich/memfs) creates a virtual file system
- [unionfs](https://github.com/streamich/unionfs) merges real fs with virtual fs
- [mock-require](https://github.com/boblauer/mock-require) intercepts and uses the above vfs whenever native fs is called
- these are setup in `lib/fs.js` dynamically based on `MFE_DEPS_TEST_FS` environment variable. This was the only way I could find to extend fs within the command spawned by tests.
